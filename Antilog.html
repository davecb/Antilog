<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=iso-8859-1">
	<TITLE></TITLE>
	<META NAME="GENERATOR" CONTENT="OpenOffice.org 2.1  (Solaris Sparc)">
	<META NAME="AUTHOR" CONTENT="David Collier-Brown">
	<META NAME="CREATED" CONTENT="20070515;14580400">
	<META NAME="CHANGEDBY" CONTENT="David Collier-Brown">
	<META NAME="CHANGED" CONTENT="20070526;14455000">
	<STYLE>
	<!--
		@page { size: 8.5in 11in; margin: 0.79in }
		P { margin-bottom: 0.08in }
		P.western { so-language: en-CA }
		H1 { margin-bottom: 0.08in }
		H1.western { font-family: "Times New Roman", serif; so-language: en-CA }
		H1.cjk { font-family: "Arial" }
		H1.ctl { font-family: "Lucidasans" }
		H3 { margin-bottom: 0.08in }
		H3.western { so-language: en-CA }
		H3.cjk { font-family: "Arial" }
		H3.ctl { font-family: "Lucidasans" }
		BLOCKQUOTE.western { so-language: en-CA }
		PRE.western { so-language: en-CA }
	-->
	</STYLE>
</HEAD>
<BODY LANG="en-CA" DIR="LTR">
<H1 CLASS="western" ALIGN=CENTER>Sherlock Homes on Log Files</H1>
<P CLASS="western">At customer after customer, whenever something
goes wrong, we get asked to look at the logs and tell them what they
mean. 
</P>
<P LANG="en-GB" CLASS="western">This is an excellent way to roll up a
large number of consulting hours, but it isn't what one really wants
to do, unless you <SPAN STYLE="font-style: normal">enjoy </SPAN>grovelling
over logs for hours, hoping to recognize something that will point
you to the problem.  Automated tools suffer from the same problem as
manual log browsing: you don't know what you're looking for until
after you've found it. 
</P>
<P LANG="en-GB" CLASS="western" STYLE="margin-bottom: 0in">However,
there is  a better way, as Sherlock Holms pointed out in <I>The
Adventure of the Beryl Coronet</I>.</P>
<P LANG="en-GB" CLASS="western" STYLE="margin-bottom: 0in"><BR>
</P>
<BLOCKQUOTE CLASS="western">It is an old maxim of mine that when you
have excluded the impossible, whatever remains, however improbable,
must be the truth 
</BLOCKQUOTE>
<P LANG="en-GB" CLASS="western">If we exclude the uninteresting,
regular or routine, then whatever remains will be extraordinary, and
likely to to be relevant to the problem we are trying to diagnose.</P>
<P LANG="en-GB" CLASS="western">Fortunately, we can exclude routine
log entries quite easily. We take all the old logs, up to but not
including the day the problem ocurred, remove the date-stamps, and
use sort -u to create a table of log entries that we've seeen
peviously. We then turn tehe table into an awk program to filter out
these lines, and run that against the logs from the day the problem
ocurred.</P>
<P LANG="en-GB" CLASS="western">For example, a machine named &ldquo;froggy&rdquo;
had a problem with Sun's update program, and the /var/adm/messages
contents for previous days, once sorted, were a series of lines like
this:</P>
<PRE CLASS="western">froggy /sbin/dhcpagent[1007]: [ID 929444 daemon.warning] configure_if: no IP broadcast specified for dmfe0, making best guess
froggy /sbin/dhcpagent[1029]: [ID 929444 daemon.warning] configure_if: no IP broadcast specified for dmfe0, making best guess
froggy gconfd (root-776): [ID 702911 user.error] file gerror.c: line 225: assertion `src != NULL' failed
froggy pcipsy: [ID 781074 kern.warning] WARNING: pcipsy0: spurious interrupt from ino 0xb
</PRE><P LANG="en-GB" CLASS="western">
A bit of editing turned this into 
</P>
<PRE CLASS="western">/dhcpagent.* configure_if: no IP broadcast specified/ { next; }
<SPAN LANG="en-GB">/gconfd.* file gerror.c: line 225/ { next; }</SPAN>
<SPAN LANG="en-GB">/pcipsy.* WARNING: pcipsy0: spurious interrupt from/ next; }</SPAN>
<SPAN LANG="en-GB">/.*/ { print $0}</SPAN></PRE><P CLASS="western">
<BR><BR>
</P>
<P CLASS="western">That's an awk program  which will remove all 
variants on these three error messages.  When the program was
extended to a mere 23 lines and run against the current day's
/var/adm/messages,  it exposed the following error:</P>
<PRE CLASS="western">froggy CNS Transport[1160]: [ID 195303 daemon.error] unhandled exception: buildSysidentInfo: IP address getSystemIPAddr error: node name or service name not known</PRE><P CLASS="western">
A little checking showed us that this was the Sun Update Connection
program complaining that there was not network available, which was
perfectly reasonable, as the machine in question was a laptop and
really wasn't connected to a network at the time the error occurred.</P>
<P CLASS="western">So we added a rule for updating-program errors,
right after the one for &ldquo;no IP broadcast specified&rdquo;,
another message that only occurs when the machine was disconnected.</P>
<P CLASS="western"><BR><BR>
</P>
<H3 CLASS="western">Turning This into a Process and a Tool</H3>
<P CLASS="western">This kind of manual programming is fine for a
on-off exercise, but it would be better to have a config file  we can
update occasionally, and run the filter program every night against
every machine via cron. Then any new messages would be reported
bright and early for us to look at, before the users discover it. 
</P>
<P CLASS="western">To make it easier, and to reduce the likelihood of
making a typographical error creating the patterns, we wrote an awk
program to translate a configuration file into proper awk patterns,
and called it antilog.  To give you an easy starting point, we put a
default config file into the program itself,  so you can just copy it
out and add local additions.</P>
<P CLASS="western">In addition, we taught it a bit more about syslog
log files, as they're very common, and added a few options for
debugging and for emailing the results to an individual or list.</P>
<P CLASS="western">Finally, we invented a notation for multiple lines
which begin with the same pattern:</P>
<PRE CLASS="western">daemon.error {
        Failed to monitor the power button.
        Unable to connect to open /dev/pm: pm-actions disabled
}</PRE><P CLASS="western">
This will create two awk commands of the form</P>
<PRE CLASS="western">	daemon.error.*Failed to monitor the power button.
	daemon.error.*Unable to connect to open /dev/pm: pm-actions disabled</PRE><P CLASS="western">
to save typing (and typos).</P>
<PRE CLASS="western"></PRE><P CLASS="western">
Our final config file looks like this:</P>
<PRE CLASS="western"># Boot time
last message repeated
Use is subject to license terms.
auth.crit {
        rebooted by root
}

# Power management
daemon.error {
        Failed to monitor the power button.
        Unable to connect to open /dev/pm: pm-actions disabled
}

# sendfail(8) blunders
mail.alert] unable to qualify my own domain name
mail.crit] My unqualified host name

# Shutdown
syslogd: going down on signal 15
daemon.error] rpcbind terminating on signal.

# DHCP
daemon.warning] configure_if: no IP broadcast specified

# Networking
NOTICE.*TX stall detected after: pass
kern.warning] WARNING: pcipsy0: spurious interrupt from ino

# Gconfd
user.error] file gerror.c. line 225. assertion

# Java
user.error {
        libpkcs11: /usr/lib/security/pkcs11_softtoken.so unexpected failure
        libpkcs11: open /var/run/kcfd_door: No such file or directory
}

# And trim off the rest of the low-priority kernel messages.
kern.notice
kern.info
</PRE><P CLASS="western">
When run, Antilog compiles the program above into:</P>
<PRE CLASS="western">/\.debug\]/ { next }
/kern.notice/ { next }
/kern.info/ { next }
/last message repeated/ { next }
/Use is subject to license terms./ { next }
/auth.crit.*rebooted by root/ { next }
/daemon.error.*Failed to monitor the power button./ { next }
/daemon.error.*Unable to connect to open \/dev\/pm: pm-actions disabled/ { next }
/mail.alert\] unable to qualify my own domain name/ { next }
/mail.crit\] My unqualified host name/ { next }
/syslogd: going down on signal 15/ { next }
/daemon.error\] rpcbind terminating on signal./ { next }
/daemon.warning\] configure_if: no IP broadcast specified/ { next }
/NOTICE.*TX stall detected after:/ { print $0; next }
/kern.warning\] WARNING: pcipsy0: spurious interrupt from ino 0x2a/ { next }
/user.error\] file gerror.c. line 225. assertion/ { next }
/user.error.*libpkcs11: \/usr\/lib\/security\/pkcs11_softtoken.so/ { next }
/user.error.*libpkcs11: open \/var\/run\/kcfd_door: No such file/ { next }
/kern.notice/ { next }
/kern.info/ { next }
/.*/ { print $0 }
</PRE><P CLASS="western">
We've used this same technique quite a number of times, for syslog
files after an Oracle crash, warning messages from a compiler and log
file from the X.org release of the X Window System, In each case it's
turned hours of reading into a few minutes of preprocessing.</P>
<H3 CLASS="western">Downloading</H3>
<PRE CLASS="western"></PRE><P CLASS="western">
The production antilog program and its man page are available at
<A HREF="http://www.datacenterworks.com/tools/antilog">http:www.datacenterworks.com/tools/antilog</A></P>
</BODY>
</HTML>